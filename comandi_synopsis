#!/bin/bash
cd /home/isa37/git/lab3/syn/
rm -r work
mkdir work
mkdir analysis_results
source /software/scripts/init_synopsys_64.18
#lancia synopsis
dc_shell-xg-t
#*******Reading VHDL source files**************
analyze -f vhdl -lib WORK ../src/riscv_pkg.vhd
analyze -f vhdl -lib WORK ../src/REGN.vhd
analyze -f vhdl -lib WORK ../src/IMM_GEN.vhd
analyze -f vhdl -lib WORK ../src/ALU.vhd
analyze -f vhdl -lib WORK ../src/ALU_CONTROL.vhd
analyze -f vhdl -lib WORK ../src/BRANCH_VALUE_PROVIDER.vhd
analyze -f vhdl -lib WORK ../src/CONTROL.vhd
analyze -f vhdl -lib WORK ../src/REGISTER_FILE.vhd
analyze -f vhdl -lib WORK ../src/PROGRAM_COUNTER_MANAGER.vhd
analyze -f vhdl -lib WORK ../src/WRITE_BACK_SELECTOR.vhd
analyze -f vhdl -lib WORK ../src/PIPE1_REG.vhd
analyze -f vhdl -lib WORK ../src/PIPE2_REG.vhd
analyze -f vhdl -lib WORK ../src/PIPE3_REG.vhd
analyze -f vhdl -lib WORK ../src/PIPE4_REG.vhd
analyze -f vhdl -lib WORK ../src/RISCV_PROCESSOR.vhd

#Before completing the reading of source we set one parameter to preserve rtl names in the netlist to ease the procedure for power consumption estimation.
set power_preserve_rtl_hier_names true
#Launch elaborate command to load the components
#elaborate <top entity name> -arch <architecture name> -lib WORK > ./elaborate.txt
elaborate  RISCV_PROCESSOR -arch rtl -lib WORK > ./elaborate_results.txt
#uniquify #optional command to addres to only 1 specific architecture
link

#*******  Applying constraints   ***************
#create 100 Mhz clock
create_clock -name MY_CLK -period 0 clk  
set_dont_touch_network MY_CLK

#jitter simulation
set_clock_uncertainty 0.07 [get_clocks MY_CLK]

#input/output delay
set_input_delay 0.5 -max -clock MY_CLK [remove_from_collection [all_inputs] clk]
set_output_delay 0.5 -max -clock MY_CLK [all_outputs]

#set output load (buffer x4 used)
set OLOAD [load_of NangateOpenCellLibrary/BUF_X4/A]
set_load $OLOAD [all_outputs]

#flatten the hiercarchy
ungroup -all -flatten
#implement the pparch multiplier
#set_implementation DW02_mult/pparch [find cell *mult*]

#*********    Start the syntesis    *************
compile >  ./analysis_results/compilation_results.txt

#compile ultra
#compile_ultra >  ./analysis_results/ultra_compilation_results.txt

#*********    Save the results      *************
report_timing  >  ./analysis_results/timing_results.txt
report_area    >  ./analysis_results/area_results.txt
report_resources > ./analysis_results/resource_report.txt

#Finally, we can save the data required to complete the design and to perform switchingactivity-based power estimation.
#ungroup -all -flatten 
#Then, we have to export the netlist in verilog. So that we impose verilog rules for the names of the internal signals. This is obtained with
change_names -hierarchy -rules verilog
#We also save a file describing the delay of the netlist:
write_sdf ../netlist/myfir.sdf
#We can now save the netlist in verilog:
write -f verilog -hierarchy -output ../netlist/myfir.v
#and the constraints to the input and output ports in a standard format:
write_sdc ../netlist/myfir.sdc


#******* close Design compiler    ****************
quit

#******* Switching actvity analysis     **********
cd labdirectory
mkdir vcd
mkdir saif

#Launch Modelsim with proper option and record switching activity
#compile the vhdl files (if any) you are using as stimulus for your test-bench.
cd /home/isa37/Documents/lab1/VHDL/sim/
vcom -93 -work ./work ../tb/clk_gen.vhd
vcom -93 -work ./work ../tb/tb_output_data_checker.vhd
vcom -93 -work ./work ../tb/tb_data_maker.vhd

#Assuming Testbench file is tb_fir.v 
#and testbench module is tb_fir
#Compile the verilog type:
vlog -work ./work ../netlist/myfir.v
vlog -work ./work ../tb/TB_FILTER.v

#link to Modelsim the compiled library of the cells
vsim -L /software/dk/nangate45/verilog/msim6.2g work.tb_fir
#link the delay file
vsim -L /software/dk/nangate45/verilog/msim6.2g -sdftyp /tb_fir/UUT=../netlist/myfir.sdf work.tb_fir
#open the VCD file:
vcd file ../vcd/myfir_syn.vcd
#Then, we specify that we want to monitor all the signals inside our unit-under-test (the FIR filter):
vcd add /tb_fir/UUT/*

#run the simulation for a value higher that the END_SIM_i signal occurance
run 5 us

#Convert the output file to SAIF file
vcd2saif -input ../vcd/myfir_syn.vcd -output ../saif/myfir_syn.saif


#*****     Power consumption estimation with Synopsys Design Compiler   *********
cd $abspath/syn
#read the netlist 
read_verilog -netlist ../netlist/myfir.v
#read the saif file generated by modelsim simulation
read_saif -input ../saif/myfir_syn.saif -instance tb_fir/UUT -unit ns -scale 1
#show the clock signal
create_clock -name MY_CLK CLK

report_power
quit















